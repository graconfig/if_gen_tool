# SAP接口设计书生成工具 - 技术架构图

## 项目概述
基于AI驱动的RAG技术进行SAP接口字段映射，支持多语言输出，通过统一的SAP AI Core平台支持多种AI模型。

---

## 整体架构图

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                          用户交互层 (User Interface Layer)                     ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        ║
║   │  CLI Interface  │    │  File Manager   │    │  API Gateway    │        ║
║   ├─────────────────┤    ├─────────────────┤    ├─────────────────┤        ║
║   │ • --file        │    │ • excel_input/  │    │ • REST API      │        ║
║   │ • --langu       │    │ • excel_output/ │    │ • Health Check  │        ║
║   │ • --provider    │    │ • excel_archive/│    │ • Status Query  │        ║
║   └─────────────────┘    └─────────────────┘    └─────────────────┘        ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                        应用编排层 (Application Orchestration)                  ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    Main Orchestrator (主编排器)                    │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  • 多文件并发调度 (ThreadPoolExecutor)                             │     ║
║   │  • 任务队列管理                                                    │     ║
║   │  • 进度跟踪与监控                                                  │     ║
║   │  • 全局异常处理                                                    │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                         核心处理层 (Core Processing Layer)                     ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    Excel Processing Engine                         │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │                                                                    │     ║
║   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │     ║
║   │  │ Field        │  │ Format       │  │ Data         │           │     ║
║   │  │ Extraction   │→ │ Detection    │→ │ Validation   │           │     ║
║   │  └──────────────┘  └──────────────┘  └──────────────┘           │     ║
║   │                                                                    │     ║
║   └────────────────────────────────────────────────────────────────────     ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    Field Matching Engine                           │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │                                                                    │     ║
║   │  ┌──────────────────────────────────────────────────────────┐    │     ║
║   │  │  Stage 1: Custom Field Priority Matching                 │    │     ║
║   │  │  • Vector Search (HANA Cloud)                            │    │     ║
║   │  │  • Similarity Threshold: 0.75                            │    │     ║
║   │  │  • Fast Path for Customer Extensions                     │    │     ║
║   │  └──────────────────────────────────────────────────────────┘    │     ║
║   │                            ↓                                       │     ║
║   │  ┌──────────────────────────────────────────────────────────┐    │     ║
║   │  │  Stage 2: CDS View Matching (AI-Powered)                 │    │     ║
║   │  │  • Business Scenario Analysis                            │    │     ║
║   │  │  • CDS View Selection                                    │    │     ║
║   │  │  • Semantic Field Mapping                                │    │     ║
║   │  └──────────────────────────────────────────────────────────┘    │     ║
║   │                                                                    │     ║
║   └────────────────────────────────────────────────────────────────────     ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    Batch Processing Engine                         │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  • Batch Size: 30 fields/batch                                    │     ║
║   │  • Concurrent Workers: 5 threads                                  │     ║
║   │  • Shared Context Optimization                                    │     ║
║   │  • Progress Tracking                                              │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
╔═══════════════════════╗  ╔═══════════════════════╗  ╔═══════════════════════╗
║   Configuration       ║  ║   Data Models         ║  ║   Utility Services    ║
╠═══════════════════════╣  ╠═══════════════════════╣  ╠═══════════════════════╣
║                       ║  ║                       ║  ║                       ║
║ ┌───────────────────┐ ║  ║ ┌───────────────────┐ ║  ║ ┌───────────────────┐ ║
║ │ Excel Config      │ ║  ║ │ InterfaceField    │ ║  ║ │ i18n Service      │ ║
║ │ • Column Mapping  │ ║  ║ │ • field_name      │ ║  ║ │ • en/zh/ja        │ ║
║ │ • SAP/Standard    │ ║  ║ │ • field_text      │ ║  ║ └───────────────────┘ ║
║ └───────────────────┘ ║  ║ │ • sample_value    │ ║  ║                       ║
║                       ║  ║ └───────────────────┘ ║  ║ ┌───────────────────┐ ║
║ ┌───────────────────┐ ║  ║                       ║  ║ │ Logger Manager    │ ║
║ │ AI Model Config   │ ║  ║ ┌───────────────────┐ ║  ║ │ • Thread-safe     │ ║
║ │ • Provider Select │ ║  ║ │ MatchResult       │ ║  ║ │ • File-based      │ ║
║ │ • Model Names     │ ║  ║ │ • cds_view        │ ║  ║ └───────────────────┘ ║
║ │ • Parameters      │ ║  ║ │ • field_mapping   │ ║  ║                       ║
║ └───────────────────┘ ║  ║ │ • confidence      │ ║  ║ ┌───────────────────┐ ║
║                       ║  ║ └───────────────────┘ ║  ║ │ Token Tracker     │ ║
║ ┌───────────────────┐ ║  ║                       ║  ║ │ • Usage Stats     │ ║
║ │ Language Config   │ ║  ║ ┌───────────────────┐ ║  ║ │ • Cost Analysis   │ ║
║ │ • Auto-detect     │ ║  ║ │ QueryString       │ ║  ║ └───────────────────┘ ║
║ │ • Fallback        │ ║  ║ │ • Builder Pattern │ ║  ║                       ║
║ └───────────────────┘ ║  ║ └───────────────────┘ ║  ║ ┌───────────────────┐ ║
║                       ║  ║                       ║  ║ │ Connection Test   │ ║
╚═══════════════════════╝  ╚═══════════════════════╝  ║ │ • AI Services     │ ║
                                                      ║ │ • HANA DB         │ ║
                                                      ║ └───────────────────┘ ║
                                                      ║                       ║
                                                      ╚═══════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                         AI服务层 (AI Service Layer)                            ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    SAP AI Core Integration                         │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  • Unified Authentication                                         │     ║
║   │  • Model Service Pool                                             │     ║
║   │  • Load Balancing & Failover                                      │     ║
║   │  • Token Management                                               │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
║   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         ║
║   │  Claude Service  │  │  Gemini Service  │  │  OpenAI Service  │         ║
║   ├──────────────────┤  ├──────────────────┤  ├──────────────────┤         ║
║   │ • Bedrock API    │  │ • Vertex AI      │  │ • GPT-4/4o       │         ║
║   │ • Claude 3.5     │  │ • Gemini 1.5 Pro │  │ • Embeddings     │         ║
║   │ • Function Call  │  │ • Function Call  │  │ • Function Call  │         ║
║   │ • Embeddings     │  │ • Embeddings     │  │ • Streaming      │         ║
║   └──────────────────┘  └──────────────────┘  └──────────────────┘         ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    AI Service Selector                             │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  Priority: User Specified → Env Config → Auto-detect              │     ║
║   │  Fallback: Claude → Gemini → OpenAI                               │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                      提示词管理层 (Prompt Management Layer)                     ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         ║
║   │ Field Matching   │  │ View Selection   │  │ Function Schema  │         ║
║   │ Prompts          │  │ Prompts          │  │ Definitions      │         ║
║   ├──────────────────┤  ├──────────────────┤  ├──────────────────┤         ║
║   │ • English        │  │ • English        │  │ • Claude Format  │         ║
║   │ • Chinese        │  │ • Chinese        │  │ • Gemini Format  │         ║
║   │ • Japanese       │  │ • Japanese       │  │ • OpenAI Format  │         ║
║   └──────────────────┘  └──────────────────┘  └──────────────────┘         ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    Template Manager                                │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  • Dynamic Template Loading                                       │     ║
║   │  • Variable Substitution                                          │     ║
║   │  • Context Injection                                              │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                      数据访问层 (Data Access Layer)                            ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    HANA Cloud Vector Database                      │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │                                                                    │     ║
║   │  ┌──────────────────────────────────────────────────────────┐    │     ║
║   │  │  Vector Search Engine                                    │    │     ║
║   │  │  • COSINE_SIMILARITY Algorithm                           │    │     ║
║   │  │  • Embedding Model: SAP NEB                              │    │     ║
║   │  │  • Real-time Indexing                                    │    │     ║
║   │  └──────────────────────────────────────────────────────────┘    │     ║
║   │                                                                    │     ║
║   │  ┌──────────────────────────────────────────────────────────┐    │     ║
║   │  │  Data Tables                                             │    │     ║
║   │  │  ┌────────────────┐  ┌────────────────┐                │    │     ║
║   │  │  │ Business       │→ │ CDS Views      │                │    │     ║
║   │  │  │ Scenarios      │  │ Table          │                │    │     ║
║   │  │  └────────────────┘  └────────────────┘                │    │     ║
║   │  │           ↓                   ↓                         │    │     ║
║   │  │  ┌────────────────┐  ┌────────────────┐                │    │     ║
║   │  │  │ View Fields    │  │ Custom Fields  │                │    │     ║
║   │  │  │ Table          │  │ Table (Priority)│               │    │     ║
║   │  │  └────────────────┘  └────────────────┘                │    │     ║
║   │  └──────────────────────────────────────────────────────────┘    │     ║
║   │                                                                    │     ║
║   └────────────────────────────────────────────────────────────────────     ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    HANA DB Client                                  │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  • Connection Pooling                                             │     ║
║   │  • Query Optimization                                             │     ║
║   │  • Transaction Management                                         │     ║
║   │  • Error Handling & Retry                                         │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                      外部集成层 (External Integration Layer)                   ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌──────────────────────┐              ┌──────────────────────┐            ║
║   │  OData Service       │              │  File System         │            ║
║   ├──────────────────────┤              ├──────────────────────┤            ║
║   │ • Field Verification │              │ • Excel I/O          │            ║
║   │ • Data Validation    │              │ • File Archiving     │            ║
║   │ • Real-time Check    │              │ • Directory Watch    │            ║
║   └──────────────────────┘              └──────────────────────┘            ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────┐     ║
║   │                    Integration Manager                             │     ║
║   ├───────────────────────────────────────────────────────────────────┤     ║
║   │  • Service Discovery                                              │     ║
║   │  • Health Monitoring                                              │     ║
║   │  • Circuit Breaker                                                │     ║
║   └───────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                      监控与管理层 (Monitoring & Management)                    ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         ║
║   │ Performance      │  │ Token Usage      │  │ Error Tracking   │         ║
║   │ Metrics          │  │ Statistics       │  │ & Logging        │         ║
║   ├──────────────────┤  ├──────────────────┤  ├──────────────────┤         ║
║   │ • Processing Time│  │ • Embedding      │  │ • Error Logs     │         ║
║   │ • Success Rate   │  │ • LLM Input      │  │ • Audit Trail    │         ║
║   │ • Throughput     │  │ • LLM Output     │  │ • Debug Info     │         ║
║   └──────────────────┘  └──────────────────┘  └──────────────────┘         ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

---

## 核心处理流程

### 字段匹配流程

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                          Excel Input File                                 ║
║                     (data/excel_input/*.xlsx)                             ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Field Extraction & Validation             │
        │  • Parse Excel structure                          │
        │  • Detect format (SAP/Standard)                   │
        │  • Extract interface fields                       │
        │  • Build InterfaceField objects                   │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                    STAGE 1: Custom Field Priority Matching                ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║   ┌───────────────────────────────────────────────────────────────┐     ║
║   │  Vector Search in Custom Fields Table                         │     ║
║   │  ┌─────────────────────────────────────────────────────┐     │     ║
║   │  │  Query = field_name + field_text + sample_value     │     │     ║
║   │  └─────────────────────────────────────────────────────┘     │     ║
║   │                          ↓                                     │     ║
║   │  ┌─────────────────────────────────────────────────────┐     │     ║
║   │  │  HANA Vector Search (COSINE_SIMILARITY)             │     │     ║
║   │  └─────────────────────────────────────────────────────┘     │     ║
║   │                          ↓                                     │     ║
║   │  ┌─────────────────────────────────────────────────────┐     │     ║
║   │  │  Filter by Threshold (similarity > 0.75)            │     │     ║
║   │  └─────────────────────────────────────────────────────┘     │     ║
║   └───────────────────────────────────────────────────────────────┘     ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
        ┌───────────────────┐         ┌───────────────────────┐
        │  Matched Fields   │         │  Unmatched Fields     │
        │  (Custom)         │         │  → Continue to Stage 2│
        └───────────────────┘         └───────────────────────┘
                    │                               ║
                    │                               ▼
                    │         ╔═══════════════════════════════════════════════╗
                    │         ║    STAGE 2: CDS View Matching (AI-Powered)   ║
                    │         ╠═══════════════════════════════════════════════╣
                    │         ║                                               ║
                    │         ║  ┌─────────────────────────────────────┐     ║
                    │         ║  │  Step 2.1: Business Scenario Search │     ║
                    │         ║  │  • Vector search in scenarios table │     ║
                    │         ║  │  • Get candidate CDS views          │     ║
                    │         ║  └─────────────────────────────────────┘     ║
                    │         ║                    ↓                          ║
                    │         ║  ┌─────────────────────────────────────┐     ║
                    │         ║  │  Step 2.2: AI View Selection        │     ║
                    │         ║  │  • LLM analyzes field context       │     ║
                    │         ║  │  • Select most relevant CDS views   │     ║
                    │         ║  │  • Rank by relevance score          │     ║
                    │         ║  └─────────────────────────────────────┘     ║
                    │         ║                    ↓                          ║
                    │         ║  ┌─────────────────────────────────────┐     ║
                    │         ║  │  Step 2.3: Get View Field Details   │     ║
                    │         ║  │  • Query view fields from HANA      │     ║
                    │         ║  │  • Build context for matching       │     ║
                    │         ║  └─────────────────────────────────────┘     ║
                    │         ║                    ↓                          ║
                    │         ║  ┌─────────────────────────────────────┐     ║
                    │         ║  │  Step 2.4: AI Field Mapping         │     ║
                    │         ║  │  • LLM semantic matching            │     ║
                    │         ║  │  • Function calling for structure   │     ║
                    │         ║  │  • Confidence score calculation     │     ║
                    │         ║  └─────────────────────────────────────┘     ║
                    │         ║                                               ║
                    │         ╚═══════════════════════════════════════════════╝
                    │                               ║
                    │                               ▼
                    │                   ┌───────────────────────┐
                    │                   │  Matched Fields       │
                    │                   │  (CDS Views)          │
                    │                   └───────────────────────┘
                    │                               ║
                    └───────────────┬───────────────┘
                                    ▼
                    ┌───────────────────────────────────────┐
                    │      Aggregate All Results            │
                    │  • Merge custom + CDS matches         │
                    │  • Remove duplicates                  │
                    │  • Sort by confidence                 │
                    └───────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                         Validation & Verification                         ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║   ┌───────────────────────────────────────────────────────────────┐     ║
║   │  OData Service Verification (Optional)                        │     ║
║   │  • Validate field existence                                   │     ║
║   │  • Check data types                                           │     ║
║   │  • Verify relationships                                       │     ║
║   └───────────────────────────────────────────────────────────────┘     ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
                    ┌───────────────────────────────────────┐
                    │      Generate Output Excel            │
                    │  • Write results to output file       │
                    │  • Include confidence scores          │
                    │  • Add mapping descriptions           │
                    └───────────────────────────────────────┘
                                    ║
                                    ▼
                    ┌───────────────────────────────────────┐
                    │      Archive Source File              │
                    │  • Move to excel_archive/             │
                    │  • Prevent reprocessing               │
                    │  • Maintain audit trail               │
                    └───────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                          Processing Complete                              ║
║                     Output: data/excel_output/*.xlsx                      ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 批量处理流程

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                    Large Field Set Detected (> 30 fields)                 ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │   Custom Field Priority Matching (All Fields)    │
        │   • Process all fields through Stage 1            │
        │   • Fast vector search                            │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
                        ┌───────────────────────┐
                        │  Unmatched Fields     │
                        │  (Require CDS Match)  │
                        └───────────────────────┘
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │      Get Shared Context (One-time Query)          │
        │  • Query business scenarios                       │
        │  • Get candidate CDS views                        │
        │  • Build common context for all batches           │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Split into Batches (batch_size=30)        │
        │  Batch 1: Fields 1-30                             │
        │  Batch 2: Fields 31-60                            │
        │  Batch 3: Fields 61-90                            │
        │  ...                                              │
        │  Batch N: Remaining fields                        │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║              Concurrent Batch Processing (max_workers=5)                  ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   ║
║   │  Thread 1   │  │  Thread 2   │  │  Thread 3   │  │  Thread 4   │   ║
║   │             │  │             │  │             │  │             │   ║
║   │  Batch 1    │  │  Batch 2    │  │  Batch 3    │  │  Batch 4    │   ║
║   │  ↓          │  │  ↓          │  │  ↓          │  │  ↓          │   ║
║   │  AI Match   │  │  AI Match   │  │  AI Match   │  │  AI Match   │   ║
║   │  ↓          │  │  ↓          │  │  ↓          │  │  ↓          │   ║
║   │  Results    │  │  Results    │  │  Results    │  │  Results    │   ║
║   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   ║
║                                                                           ║
║   ┌─────────────┐                                                        ║
║   │  Thread 5   │         ... More batches processed in parallel         ║
║   │             │                                                        ║
║   │  Batch 5    │                                                        ║
║   │  ↓          │         ┌─────────────────────────────────┐           ║
║   │  AI Match   │         │  Progress Tracking              │           ║
║   │  ↓          │         │  • Completed: X/N batches       │           ║
║   │  Results    │         │  • Success rate: Y%             │           ║
║   └─────────────┘         │  • Estimated time remaining     │           ║
║                           └─────────────────────────────────┘           ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Aggregate Batch Results                   │
        │  • Collect results from all threads               │
        │  • Merge with custom field matches                │
        │  • Handle partial failures                        │
        │  • Calculate overall statistics                   │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                         Write to Excel Output                             ║
║                    (All results in single file)                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### AI服务选择流程

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                         Application Startup                               ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
                    ┌───────────────────────────────────────┐
                    │   Check --provider CLI Parameter      │
                    └───────────────────────────────────────┘
                                    ║
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
        ┌───────────────────┐         ┌───────────────────────┐
        │  Provider         │         │  No Provider          │
        │  Specified        │         │  Specified            │
        └───────────────────┘         └───────────────────────┘
                    ║                               ║
                    ▼                               ▼
        ┌───────────────────┐         ┌───────────────────────┐
        │  Use Specified    │         │  Check AI_PROVIDER    │
        │  Provider         │         │  Environment Variable │
        │  • claude         │         └───────────────────────┘
        │  • gemini         │                     ║
        │  • openai         │         ┌───────────┴───────────┐
        └───────────────────┘         ▼                       ▼
                    ║         ┌───────────────┐   ┌───────────────────┐
                    ║         │  Env Variable │   │  No Env Variable  │
                    ║         │  Set          │   │  Set              │
                    ║         └───────────────┘   └───────────────────┘
                    ║                 ║                       ║
                    ║                 ▼                       ▼
                    ║         ┌───────────────┐   ┌───────────────────┐
                    ║         │  Use Env      │   │  Auto-detect      │
                    ║         │  Provider     │   │  Available Service│
                    ║         └───────────────┘   └───────────────────┘
                    ║                 ║                       ║
                    └─────────────────┴───────────────────────┘
                                      ║
                                      ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                    Service Availability Testing                           ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║   Priority Order: Claude → Gemini → OpenAI                               ║
║                                                                           ║
║   ┌─────────────────────────────────────────────────────────────┐       ║
║   │  Test 1: Claude Service                                     │       ║
║   │  ┌────────────────────────────────────────────────────┐    │       ║
║   │  │  • Check SAP AI Core connection                    │    │       ║
║   │  │  • Verify Claude model availability                │    │       ║
║   │  │  • Test with simple request                        │    │       ║
║   │  └────────────────────────────────────────────────────┘    │       ║
║   │                        ↓                                     │       ║
║   │  ┌────────────────────────────────────────────────────┐    │       ║
║   │  │  Success? → Return Claude Service                  │    │       ║
║   │  │  Failure? → Continue to next                       │    │       ║
║   │  └────────────────────────────────────────────────────┘    │       ║
║   └─────────────────────────────────────────────────────────────┘       ║
║                                                                           ║
║   ┌─────────────────────────────────────────────────────────────┐       ║
║   │  Test 2: Gemini Service                                     │       ║
║   │  ┌────────────────────────────────────────────────────┐    │       ║
║   │  │  • Check SAP AI Core connection                    │    │       ║
║   │  │  • Verify Gemini model availability                │    │       ║
║   │  │  • Test with simple request                        │    │       ║
║   │  └────────────────────────────────────────────────────┘    │       ║
║   │                        ↓                                     │       ║
║   │  ┌────────────────────────────────────────────────────┐    │       ║
║   │  │  Success? → Return Gemini Service                  │    │       ║
║   │  │  Failure? → Continue to next                       │    │       ║
║   │  └────────────────────────────────────────────────────┘    │       ║
║   └─────────────────────────────────────────────────────────────┘       ║
║                                                                           ║
║   ┌─────────────────────────────────────────────────────────────┐       ║
║   │  Test 3: OpenAI Service                                     │       ║
║   │  ┌────────────────────────────────────────────────────┐    │       ║
║   │  │  • Check SAP AI Core connection                    │    │       ║
║   │  │  • Verify OpenAI model availability                │    │       ║
║   │  │  • Test with simple request                        │    │       ║
║   │  └────────────────────────────────────────────────────┘    │       ║
║   │                        ↓                                     │       ║
║   │  ┌────────────────────────────────────────────────────┐    │       ║
║   │  │  Success? → Return OpenAI Service                  │    │       ║
║   │  │  Failure? → Raise Error (No service available)    │    │       ║
║   │  └────────────────────────────────────────────────────┘    │       ║
║   └─────────────────────────────────────────────────────────────┘       ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                      ║
                                      ▼
                    ┌───────────────────────────────────────┐
                    │   Return Selected AI Service          │
                    │   • Service initialized               │
                    │   • Ready for processing              │
                    │   • Token tracking enabled            │
                    └───────────────────────────────────────┘
```

---

## 技术栈

### 核心依赖

| 类别 | 技术 | 用途 |
|------|------|------|
| **AI服务** | SAP AI Core SDK | 统一AI服务访问 |
| | OpenAI, Gemini, Claude | 多模型支持 |
| **数据库** | HANA Cloud | 向量数据库 + 业务数据 |
| **数据处理** | pandas, openpyxl | Excel处理与数据分析 |
| **并发** | ThreadPoolExecutor | 多线程并发处理 |
| **国际化** | gettext | 多语言支持 (en/zh/ja) |

### 关键技术特性

#### 1. RAG (检索增强生成)
- 向量检索: HANA Cloud向量搜索
- 语义相似度: COSINE_SIMILARITY
- 两阶段检索: 客户化字段 → CDS视图

#### 2. 多线程并发
- 文件级并发: 多个Excel文件同时处理
- 批次级并发: 大文件分批并行处理
- 线程安全: Lock保护共享资源

#### 3. Token追踪
- 实时统计: 每次AI调用的Token消耗
- 多维度: 总体/按提供商/按文件
- 持久化: JSON格式保存

#### 4. 国际化
- 支持语言: 英文、中文、日文
- 自动检测: 环境变量 → OS语言 → 默认语言
- 翻译文件: GNU gettext格式

---

## 数据流图

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                            Excel Input File                               ║
║                         (Raw Interface Definition)                        ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Field Extraction Module                   │
        │  ┌─────────────────────────────────────────┐     │
        │  │  InterfaceField Object Creation         │     │
        │  │  • field_name: str                      │     │
        │  │  • field_text: str                      │     │
        │  │  • sample_value: str                    │     │
        │  │  • data_type: str                       │     │
        │  │  • is_mandatory: bool                   │     │
        │  └─────────────────────────────────────────┘     │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                    Custom Field Matching Pipeline                         ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║   ┌───────────────────────────────────────────────────────────────┐     ║
║   │  Build Search Query                                           │     ║
║   │  ┌─────────────────────────────────────────────────────┐     │     ║
║   │  │  query = field_name + " " +                         │     │     ║
║   │  │          field_text + " " +                         │     │     ║
║   │  │          sample_value                               │     │     ║
║   │  └─────────────────────────────────────────────────────┘     │     ║
║   └───────────────────────────────────────────────────────────────┘     ║
║                                    ↓                                      ║
║   ┌───────────────────────────────────────────────────────────────┐     ║
║   │  HANA Vector Search                                           │     ║
║   │  ┌─────────────────────────────────────────────────────┐     │     ║
║   │  │  SELECT * FROM custom_fields_table                  │     │     ║
║   │  │  ORDER BY COSINE_SIMILARITY(embedding, query_vec)   │     │     ║
║   │  │  LIMIT 10                                           │     │     ║
║   │  └─────────────────────────────────────────────────────┘     │     ║
║   └───────────────────────────────────────────────────────────────┘     ║
║                                    ↓                                      ║
║   ┌───────────────────────────────────────────────────────────────┐     ║
║   │  Similarity Filtering                                         │     ║
║   │  • Threshold: 0.75                                            │     ║
║   │  • Keep only high-confidence matches                          │     ║
║   └───────────────────────────────────────────────────────────────┘     ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
        ┌───────────────────┐         ┌───────────────────────┐
        │  Matched Fields   │         │  Unmatched Fields     │
        │  ┌─────────────┐  │         │  → CDS View Matching  │
        │  │ MatchResult │  │         └───────────────────────┘
        │  │ • cds_view  │  │                     ║
        │  │ • field_map │  │                     ▼
        │  │ • score     │  │         ╔═══════════════════════════════════╗
        │  └─────────────┘  │         ║  CDS View Matching Pipeline       ║
        └───────────────────┘         ╠═══════════════════════════════════╣
                    │                 ║                                   ║
                    │                 ║  ┌─────────────────────────────┐ ║
                    │                 ║  │ Business Scenario Search    │ ║
                    │                 ║  │ • Vector search scenarios   │ ║
                    │                 ║  │ • Get candidate CDS views   │ ║
                    │                 ║  └─────────────────────────────┘ ║
                    │                 ║              ↓                    ║
                    │                 ║  ┌─────────────────────────────┐ ║
                    │                 ║  │ HANA Query: Get CDS Views   │ ║
                    │                 ║  │ • View names                │ ║
                    │                 ║  │ • View descriptions         │ ║
                    │                 ║  │ • Related scenarios         │ ║
                    │                 ║  └─────────────────────────────┘ ║
                    │                 ║              ↓                    ║
                    │                 ║  ┌─────────────────────────────┐ ║
                    │                 ║  │ AI Service: View Selection  │ ║
                    │                 ║  │ ┌─────────────────────────┐ │ ║
                    │                 ║  │ │ LLM analyzes context    │ │ ║
                    │                 ║  │ │ Function calling output │ │ ║
                    │                 ║  │ │ Returns: [view1, view2] │ │ ║
                    │                 ║  │ └─────────────────────────┘ │ ║
                    │                 ║  └─────────────────────────────┘ ║
                    │                 ║              ↓                    ║
                    │                 ║  ┌─────────────────────────────┐ ║
                    │                 ║  │ HANA Query: Get View Fields │ ║
                    │                 ║  │ • Field names               │ ║
                    │                 ║  │ • Field descriptions        │ ║
                    │                 ║  │ • Data types                │ ║
                    │                 ║  └─────────────────────────────┘ ║
                    │                 ║              ↓                    ║
                    │                 ║  ┌─────────────────────────────┐ ║
                    │                 ║  │ AI Service: Field Mapping   │ ║
                    │                 ║  │ ┌─────────────────────────┐ │ ║
                    │                 ║  │ │ LLM semantic matching   │ │ ║
                    │                 ║  │ │ Function calling output │ │ ║
                    │                 ║  │ │ Returns: MatchResult[]  │ │ ║
                    │                 ║  │ └─────────────────────────┘ │ ║
                    │                 ║  └─────────────────────────────┘ ║
                    │                 ║                                   ║
                    │                 ╚═══════════════════════════════════╝
                    │                               ║
                    │                               ▼
                    │                   ┌───────────────────┐
                    │                   │  Matched Fields   │
                    │                   │  (CDS Views)      │
                    │                   └───────────────────┘
                    │                               ║
                    └───────────────┬───────────────┘
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Result Aggregation & Merging              │
        │  • Combine custom + CDS matches                   │
        │  • Remove duplicates (prefer custom)              │
        │  • Sort by confidence score                       │
        │  • Calculate statistics                           │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                         OData Verification (Optional)                     ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║   ┌───────────────────────────────────────────────────────────────┐     ║
║   │  For each matched field:                                      │     ║
║   │  • Call OData service                                         │     ║
║   │  • Verify field existence                                     │     ║
║   │  • Check data type compatibility                              │     ║
║   │  • Update verification status                                 │     ║
║   └───────────────────────────────────────────────────────────────┘     ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Excel Output Generation                   │
        │  ┌─────────────────────────────────────────┐     │
        │  │  Write to output file:                  │     │
        │  │  • Original fields                      │     │
        │  │  • Matched CDS view                     │     │
        │  │  • Matched field name                   │     │
        │  │  • Confidence score (%)                 │     │
        │  │  • Mapping description                  │     │
        │  │  • Verification status                  │     │
        │  └─────────────────────────────────────────┘     │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
        ┌───────────────────────────────────────────────────┐
        │         Source File Archiving                     │
        │  • Move from excel_input/ to excel_archive/       │
        │  • Timestamp added to filename                    │
        │  • Prevent reprocessing                           │
        └───────────────────────────────────────────────────┘
                                    ║
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                         Processing Complete                               ║
║                                                                           ║
║   Output Files:                                                           ║
║   • data/excel_output/[filename]_output.xlsx                              ║
║   • tokens/token_usage_[timestamp].json                                   ║
║   • logs/[filename].log                                                   ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 核心算法

### 两阶段匹配策略

**阶段1: 客户化字段优先**
- 精确匹配客户化扩展字段
- 基于向量相似度
- 减少AI调用成本

**阶段2: CDS视图匹配**
- 覆盖标准SAP字段
- AI智能选择相关视图
- 上下文感知匹配

### 批量处理优化

**策略选择**
- 小批量 (≤30): 单次处理
- 大批量 (>30): 分批并发

**优化点**
- 共享上下文: CDS视图只查询一次
- 并发执行: 多批次同时处理
- 进度跟踪: 实时显示进度
- 错误隔离: 单批次失败不影响其他

### AI服务容错

**优先级**
1. 用户指定 (--provider)
2. 环境配置 (AI_PROVIDER)
3. 自动选择 (Claude → Gemini → OpenAI)

**容错机制**
- 逐个测试可用性
- 返回第一个可用服务
- 失败时抛出明确错误

---

## 配置管理

### 环境变量

```bash
# SAP AI Core
AICORE_AUTH_URL, AICORE_CLIENT_ID, AICORE_CLIENT_SECRET
AICORE_BASE_URL, AICORE_RESOURCE_GROUP

# HANA Cloud
HANA_ADDRESS, HANA_PORT, HANA_USER, HANA_PASSWORD
HANA_SCHEMA, HANA_SCHEMA_CUST

# AI模型
AI_PROVIDER (claude/gemini/openai)
OPENAI_LLM_MODEL, CLAUDE_LLM_MODEL, GEMINI_LLM_MODEL

# 处理配置
LLM_BATCH_SIZE (默认: 30)
LLM_MAX_WORKERS (默认: 5)
FILE_MAX_WORKERS (默认: 5)
CUSTOM_FIELD_THRESHOLD (默认: 0.75)

# 其他
LANGUAGE (en/zh/ja)
ODATA_URL, ODATA_USER, ODATA_PASSWORD
```

### 列映射配置

系统自动检测Excel格式:
- 检测单元格包含"SAP" → 使用SAP格式映射
- 否则 → 使用标准格式映射

---

## 性能优化

### 并发处理

```
文件级并发 (FILE_MAX_WORKERS=5)
  ├─ File 1, 2, 3, 4, 5 并行处理

批次级并发 (LLM_MAX_WORKERS=5)
  ├─ Batch 1, 2, 3, 4, 5 并行AI调用
```

### 缓存复用

- CDS视图查询: 批量处理中只查询一次
- HANA连接: 单例模式，应用生命周期复用
- AI客户端: 懒加载，首次使用时创建

### Token优化

- 客户化字段优先 → 减少AI调用
- 视图预筛选 → 减少上下文大小
- 批量处理 → 减少重复上下文

---

## 错误处理

### 错误层次

```
应用级错误 → error_*.log
  ├─ 配置错误
  ├─ 文件不存在
  └─ 无可用AI服务

文件级错误 → {filename}.log
  ├─ Excel格式错误
  ├─ 工作表不存在
  └─ 数据库连接失败

批次级错误 → 继续处理其他批次
  ├─ AI调用超时
  ├─ Token限制
  └─ 网络错误

字段级错误 → 返回空结果
  ├─ 匹配失败
  └─ 验证失败
```

### 日志管理

- 线程安全的日志记录
- 按文件分离日志
- 多语言日志消息
- 时间戳精确到秒

---

## 扩展性

### 新增AI提供商
1. 创建服务类 (实现统一接口)
2. 注册到AIProvider常量
3. 添加配置项
4. 更新服务工厂

### 新增语言支持
1. 创建翻译文件 (locale/{lang}/)
2. 创建提示词文件 (prompts_{lang}.py)
3. 注册到Languages常量

### 新增数据源
1. 扩展HANADBClient方法
2. 在ExcelProcessor中集成
3. 更新匹配逻辑

---

## 监控统计

### Token使用报告

```json
{
  "usage": {
    "embedding_tokens": 12500,
    "llm_input_tokens": 45000,
    "llm_output_tokens": 8500,
    "llm_total_tokens": 53500
  },
  "provider_usage": { ... },
  "file_usage": { ... },
  "timestamp": "2025-11-14T13:45:21"
}
```

### 性能指标

- 文件处理时间
- 批次处理时间
- 平均字段处理时间
- 匹配成功率
- AI调用成功率
