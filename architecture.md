# SAP接口设计书生成工具 - 技术架构图

## 项目概述
基于AI驱动的RAG技术进行SAP接口字段映射，支持多语言输出，通过统一的SAP AI Core平台支持多种AI模型。

---

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户交互层 (User Interface)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  • 命令行参数: --file, --langu (en/zh/ja), --provider (claude/gemini/openai)│
│  • Excel文件: 输入目录 → 输出目录 → 归档目录                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        应用核心层 (Application Core)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  • 多文件并发处理 (ThreadPoolExecutor)                                        │
│  • 进度跟踪与日志管理                                                         │
│  • Token使用统计                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         业务逻辑层 (Business Logic)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  Excel处理引擎                                                                │
│  ├─ 字段提取与格式检测 (SAP/非SAP)                                            │
│  ├─ 客户化字段优先匹配 (向量检索)                                             │
│  ├─ CDS视图智能选择 (AI驱动)                                                 │
│  ├─ 批量并发处理 (分批+多线程)                                                │
│  └─ 结果验证与写入                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
        ↓                           ↓                           ↓
┌──────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│   配置管理        │  │   数据模型            │  │   工具服务            │
├──────────────────┤  ├──────────────────────┤  ├──────────────────────┤
│ • Excel配置      │  │ • InterfaceField     │  │ • 国际化 (i18n)       │
│ • 列映射配置      │  │ • 字段数据结构        │  │ • 日志管理            │
│ • AI模型配置      │  │ • 查询字符串生成      │  │ • Token统计           │
│ • 语言配置        │  │                      │  │ • AI连接测试          │
└──────────────────┘  └──────────────────────┘  └──────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI服务层 (AI Services)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  统一通过 SAP AI Core 访问多种AI模型                                           │
│                                                                               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │   Claude     │    │   Gemini     │    │   OpenAI     │                  │
│  │  (Bedrock)   │    │  (Vertex AI) │    │   (GPT-4)    │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                                               │
│  • Function Calling (结构化输出)                                              │
│  • Embeddings生成 (向量化)                                                    │
│  • Token追踪与统计                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                      提示词管理层 (Prompt Management)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  • 字段匹配提示词模板 (多语言)                                                 │
│  • 视图选择提示词模板 (多语言)                                                 │
│  • Function Schema定义 (适配不同AI模型)                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                      数据访问层 (Data Access Layer)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  HANA Cloud 向量数据库                                                        │
│  ├─ 向量检索 (COSINE_SIMILARITY)                                             │
│  ├─ 业务场景表 → CDS视图表 → 视图字段表                                        │
│  └─ 客户化字段表 (优先匹配)                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                      外部集成层 (External Integration)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  • OData服务 (字段验证)                                                       │
│  • SAP AI Core (统一AI服务平台)                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心处理流程

### 字段匹配流程

```
Excel输入文件
    ↓
提取字段
    ↓
┌─────────────────────────────────────┐
│ 步骤1: 客户化字段优先匹配             │
│ • 向量检索客户化字段表                │
│ • 相似度阈值过滤 (>0.6)              │
└─────────────────────────────────────┘
    ↓
已匹配字段 ←─────┐
    ↓            │
未匹配字段        │
    ↓            │
┌─────────────────────────────────────┐
│ 步骤2: CDS视图匹配                   │
│ • 向量检索业务场景                   │
│ • 获取候选CDS视图                    │
│ • AI选择相关视图                     │
│ • 获取视图字段                       │
│ • AI字段匹配                         │
└─────────────────────────────────────┘
    ↓
合并结果 (已匹配 + 新匹配)
    ↓
OData验证
    ↓
写入Excel → 归档源文件
```

### 批量处理流程

```
大量字段 (>30条)
    ↓
客户化字段优先匹配 (所有字段)
    ↓
未匹配字段
    ↓
获取共享上下文 (一次性)
    ↓
分批处理 (batch_size=30)
    ↓
┌─────────────────────────────────────┐
│ 多线程并发处理 (max_workers=5)       │
│ Batch 1, 2, 3... N 并行执行          │
└─────────────────────────────────────┘
    ↓
合并所有批次结果 → 写入Excel
```

### AI服务选择流程

```
启动应用
    ↓
检查 --provider 参数
    ↓
    ├─ 指定 → 直接使用
    └─ 未指定 → 自动选择
        ↓
    检查 AI_PROVIDER 环境变量
        ↓
        ├─ 已配置 → 优先使用
        └─ 未配置 → 按优先级测试
            ↓
        Claude → Gemini → OpenAI
            ↓
        返回第一个可用服务
```

---

## 技术栈

### 核心依赖

| 类别 | 技术 | 用途 |
|------|------|------|
| **AI服务** | SAP AI Core SDK | 统一AI服务访问 |
| | OpenAI, Gemini, Claude | 多模型支持 |
| **数据库** | HANA Cloud | 向量数据库 + 业务数据 |
| **数据处理** | pandas, openpyxl | Excel处理与数据分析 |
| **并发** | ThreadPoolExecutor | 多线程并发处理 |
| **国际化** | gettext | 多语言支持 (en/zh/ja) |

### 关键技术特性

#### 1. RAG (检索增强生成)
- 向量检索: HANA Cloud向量搜索
- 语义相似度: COSINE_SIMILARITY
- 两阶段检索: 客户化字段 → CDS视图

#### 2. 多线程并发
- 文件级并发: 多个Excel文件同时处理
- 批次级并发: 大文件分批并行处理
- 线程安全: Lock保护共享资源

#### 3. Token追踪
- 实时统计: 每次AI调用的Token消耗
- 多维度: 总体/按提供商/按文件
- 持久化: JSON格式保存

#### 4. 国际化
- 支持语言: 英文、中文、日文
- 自动检测: 环境变量 → OS语言 → 默认语言
- 翻译文件: GNU gettext格式

---

## 数据流图

```
Excel输入
    ↓
字段提取 (InterfaceField)
    ↓
┌──────────────────────────┐
│ 客户化字段匹配            │
│ query = field_name +     │
│         field_text +     │
│         sample_value     │
│    ↓                     │
│ HANA向量检索             │
│    ↓                     │
│ 相似度过滤 (>0.6)        │
└──────────────────────────┘
    ↓
    ├─→ 已匹配 ──────────────┐
    │                        │
    ↓                        │
未匹配字段                   │
    ↓                        │
┌──────────────────────────┐│
│ CDS视图匹配              ││
│ • 向量检索业务场景        ││
│ • 获取候选CDS视图         ││
│ • LLM选择相关视图         ││
│ • 获取视图字段            ││
│ • LLM字段匹配             ││
└──────────────────────────┘│
    ↓                        │
AI服务 (Function Calling)    │
    ↓                        │
结果合并 ←───────────────────┘
    ↓
OData验证
    ↓
Excel输出 + 源文件归档
```

---

## 核心算法

### 两阶段匹配策略

**阶段1: 客户化字段优先**
- 精确匹配客户化扩展字段
- 基于向量相似度
- 减少AI调用成本

**阶段2: CDS视图匹配**
- 覆盖标准SAP字段
- AI智能选择相关视图
- 上下文感知匹配

### 批量处理优化

**策略选择**
- 小批量 (≤30): 单次处理
- 大批量 (>30): 分批并发

**优化点**
- 共享上下文: CDS视图只查询一次
- 并发执行: 多批次同时处理
- 进度跟踪: 实时显示进度
- 错误隔离: 单批次失败不影响其他

### AI服务容错

**优先级**
1. 用户指定 (--provider)
2. 环境配置 (AI_PROVIDER)
3. 自动选择 (Claude → Gemini → OpenAI)

**容错机制**
- 逐个测试可用性
- 返回第一个可用服务
- 失败时抛出明确错误

---

## 配置管理

### 环境变量

```bash
# SAP AI Core
AICORE_AUTH_URL, AICORE_CLIENT_ID, AICORE_CLIENT_SECRET
AICORE_BASE_URL, AICORE_RESOURCE_GROUP

# HANA Cloud
HANA_ADDRESS, HANA_PORT, HANA_USER, HANA_PASSWORD
HANA_SCHEMA, HANA_SCHEMA_CUST

# AI模型
AI_PROVIDER (claude/gemini/openai)
OPENAI_LLM_MODEL, CLAUDE_LLM_MODEL, GEMINI_LLM_MODEL

# 处理配置
LLM_BATCH_SIZE (默认: 30)
LLM_MAX_WORKERS (默认: 5)
FILE_MAX_WORKERS (默认: 5)
CUSTOM_FIELD_THRESHOLD (默认: 0.75)

# 其他
LANGUAGE (en/zh/ja)
ODATA_URL, ODATA_USER, ODATA_PASSWORD
```

### 列映射配置

系统自动检测Excel格式:
- 检测单元格包含"SAP" → 使用SAP格式映射
- 否则 → 使用标准格式映射

---

## 性能优化

### 并发处理

```
文件级并发 (FILE_MAX_WORKERS=5)
  ├─ File 1, 2, 3, 4, 5 并行处理

批次级并发 (LLM_MAX_WORKERS=5)
  ├─ Batch 1, 2, 3, 4, 5 并行AI调用
```

### 缓存复用

- CDS视图查询: 批量处理中只查询一次
- HANA连接: 单例模式，应用生命周期复用
- AI客户端: 懒加载，首次使用时创建

### Token优化

- 客户化字段优先 → 减少AI调用
- 视图预筛选 → 减少上下文大小
- 批量处理 → 减少重复上下文

---

## 错误处理

### 错误层次

```
应用级错误 → error_*.log
  ├─ 配置错误
  ├─ 文件不存在
  └─ 无可用AI服务

文件级错误 → {filename}.log
  ├─ Excel格式错误
  ├─ 工作表不存在
  └─ 数据库连接失败

批次级错误 → 继续处理其他批次
  ├─ AI调用超时
  ├─ Token限制
  └─ 网络错误

字段级错误 → 返回空结果
  ├─ 匹配失败
  └─ 验证失败
```

### 日志管理

- 线程安全的日志记录
- 按文件分离日志
- 多语言日志消息
- 时间戳精确到秒

---

## 扩展性

### 新增AI提供商
1. 创建服务类 (实现统一接口)
2. 注册到AIProvider常量
3. 添加配置项
4. 更新服务工厂

### 新增语言支持
1. 创建翻译文件 (locale/{lang}/)
2. 创建提示词文件 (prompts_{lang}.py)
3. 注册到Languages常量

### 新增数据源
1. 扩展HANADBClient方法
2. 在ExcelProcessor中集成
3. 更新匹配逻辑

---

## 监控统计

### Token使用报告

```json
{
  "usage": {
    "embedding_tokens": 12500,
    "llm_input_tokens": 45000,
    "llm_output_tokens": 8500,
    "llm_total_tokens": 53500
  },
  "provider_usage": { ... },
  "file_usage": { ... },
  "timestamp": "2025-11-14T13:45:21"
}
```

### 性能指标

- 文件处理时间
- 批次处理时间
- 平均字段处理时间
- 匹配成功率
- AI调用成功率
